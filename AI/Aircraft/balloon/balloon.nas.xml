<?xml version="1.0"?>
<!--
This is the nasal part for a balloon model
Use by adding <nasal include="balloon.nas.xml"/> to your AI model
After loading the model, it is placed on the ground randomly 800-1200m 
in front of your aircraft within +/- 10 degrees. It will leave ground
after 5-25 seconds and climb up to 1500-2500ft above ground elevation.
-->
<PropertyList>
  <load><![CDATA[
  var self = cmdarg();
  printlog("info", "loading ballon at ", self.getPath() );

  self.getNode("controls/flight/lateral-mode",1).setValue("yaw");
  var windh = props.globals.getNode("environment/wind-from-heading-deg",1);
  var winds = props.globals.getNode("environment/wind-speed-kt",1);   
  var speed = self.getNode("controls/flight/target-spd",1);
  var head = self.getNode("controls/flight/target-hdg",1);
  var running = self.getNode("engines/engine[0]/running",1);
  running.setBoolValue(0); # start with engine (flame) off
  var flame_on_time = 10.0 + 10.0*rand();
  var flame_off_time = 30.0 + 10.0*rand();

  var position = geo.aircraft_position();
  position.apply_course_distance( 
    props.globals.getNode("orientation/heading-deg", 1).getValue()-10.0+20*rand(), 
    800 + 400*rand());
  var elevation = geo.elevation( position.lat(), position.lon() ) * globals.M2FT;
  position.set_alt( elevation != nil ? elevation : 0.0 );
  self.getNode("controls/flight/target-alt", 1 ).setValue( position.alt() );

  self.getNode("position/latitude-deg",1).setDoubleValue( position.lat() );
  self.getNode("position/longitude-deg",1).setDoubleValue( position.lon() );
  self.getNode("position/altitude-ft", 1 ).setValue( position.alt() );

  var loopid = 0;

  var flameLoop = func(id) {
    id == loopid or return;
    var b = running.getValue();
    running.setBoolValue( b == 0 );
    settimer( func { flameLoop(id) }, b ? flame_off_time : flame_on_time );
  }

  var loop = func(id) {
    id == loopid or return;
    speed.setValue(winds.getValue());
    head.setValue(geo.normdeg(windh.getValue() + 180.0));
    settimer(func { loop(id) }, 10.0 );
  }

  settimer( func {
    flameLoop(loopid);
    self.getNode("controls/flight/target-alt", 1 ).setValue( position.alt() + 1500 + 1000*rand());
    settimer(func { loop(loopid) }, 0.5);
  }, 5.0 + 20.0*rand() );
  ]]></load>
  <unload><![CDATA[
  printlog("info", "unloading balloon");
  loopid += 1;
  ]]></unload>
</PropertyList>
